<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.braveg.chart.ChartMapper">
    <!--    매시간별 순위 LIST    -->
    <select id="getTodayRankList" resultType="HashMap">
        SELECT *
        FROM TODAY_RANK
        WHERE stime = DATE_FORMAT(NOW(),'%H')
        ORDER BY site, ranking*1
    </select>
    <!--    일일 순위 LIST    -->
    <select id="getDateRankList" resultType="HashMap">
        SELECT *
        FROM DATE_RANK
        WHERE sdate = DATE_FORMAT(NOW(),'%Y%m%d')
        ORDER BY site, ranking*1
    </select>
    <!--    매시간별 순위    -->
    <insert id="insertEachHour" parameterType="com.braveg.chart.ChartDto">
        INSERT INTO TODAY_RANK (site, title, stime, ranking)
        VALUES ( #{site}, #{title}, date_format(now(), '%H'), #{ranking} )
        ON DUPLICATE KEY UPDATE
        ranking = #{ranking}
    </insert>
    <!--    일일 순위    -->
    <insert id="insertDate" parameterType="com.braveg.chart.ChartDto">
        INSERT INTO DATE_RANK(site, title, sdate, ranking)
        VALUES ( #{site}, #{title}, DATE_FORMAT(now(),'%Y%m%d'), #{ranking} )
    </insert>
    <!--    초기화    -->
    <delete id="resetEachHour">
        DELETE FROM TODAY_RANK
    </delete>

    <!-- 사이트별 순위,,그래프그리기,,, LIST    -->
    <select id="getRankForGraphList" resultType="HashMap">
        SELECT *
        FROM DATE_RANK
        where site = #{site}
        ORDER BY site, title, sdate;
    </select>

<!--    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////    -->
        <insert id="insertVisitor" parameterType="com.braveg.chart.VisitDto">
        INSERT INTO VISITOR (
            VISIT_ID,
            VISIT_IP,
            VISIT_TIME,
            VISIT_REFER,
            VISIT_AGENT
        )
        SELECT
                CASE COUNT(*) WHEN 0 THEN 1 ELSE COUNT(*)+1 END AS VISIT_ID
            ,   #{visit_ip} AS VISIT_IP
            ,   DATE_FORMAT(now(), '%Y%m%d%H%i%s') AS VISIT_TIME
            ,   #{visit_refer} AS VISIT_REFER
            ,   #{visit_agent} AS VISIT_AGENT
        FROM VISITOR

    </insert>

    <select id="getTodayCnt" resultType="Integer">
        SELECT
            CASE COUNT(*) WHEN 0 THEN 1 ELSE COUNT(*) END AS VISIT_ID
        FROM VISITOR
        WHERE DATE_FORMAT(VISIT_TIME, '%Y%m%d') = DATE_FORMAT(now(), '%Y%m%d')
    </select>

    <select id="getTotalCnt" resultType="Integer">
        SELECT
            CASE COUNT(*) WHEN 0 THEN 1 ELSE COUNT(*) END AS VISIT_ID
        FROM VISITOR
    </select>
</mapper>